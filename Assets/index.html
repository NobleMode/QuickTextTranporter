<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QuickText Web Client</title>
    <script src="/lib/tailwind.js"></script>
    <link rel="stylesheet" href="/lib/toastify.css" />
    <script src="/lib/toastify.js"></script>
    <style>
      /* Custom scrollbar for textareas */
      textarea::-webkit-scrollbar {
        width: 8px;
      }
      textarea::-webkit-scrollbar-track {
        background: transparent;
      }
      textarea::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 4px;
      }
      textarea::-webkit-scrollbar-thumb:hover {
        background-color: #94a3b8;
      }
    </style>
  </head>
  <body
    class="bg-slate-50 text-slate-900 min-h-screen font-sans antialiased selection:bg-blue-100 selection:text-blue-900"
  >
    <div class="max-w-3xl mx-auto p-4 sm:p-6 lg:p-8 space-y-8">
      <!-- Header -->
      <header
        class="flex items-center justify-between pb-6 border-b border-slate-200"
      >
        <div>
          <h1 class="text-2xl font-bold tracking-tight text-slate-900">
            QuickText Client
          </h1>
          <p class="text-sm text-slate-500 mt-1">
            Connected to <span id="hostName">Host</span>
          </p>
        </div>
        <div class="flex flex-col items-end text-xs text-slate-400">
          <div class="flex items-center gap-2">
            <span
              class="w-2 h-2 rounded-full bg-green-500 animate-pulse"
            ></span>
            <span>Connected</span>
          </div>
          <div class="mt-1 font-mono" id="clientIp">Loading IP...</div>
        </div>
      </header>

      <!-- Main Content Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Host Text Section -->
        <section class="space-y-3">
          <div class="flex items-center justify-between">
            <label class="text-sm font-medium text-slate-700">Host Text</label>
            <button
              onclick="copyText('hostText')"
              class="text-xs font-medium text-blue-600 hover:text-blue-700 transition-colors"
            >
              Copy
            </button>
          </div>
          <div class="relative group h-full">
            <textarea
              id="hostText"
              readonly
              class="w-full h-48 md:h-64 p-3 bg-white border border-slate-200 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 resize-none font-mono text-sm text-slate-600 transition-all cursor-default"
            ></textarea>
          </div>
        </section>

        <!-- Client Text Section -->
        <section class="space-y-3">
          <div class="flex items-center justify-between">
            <label class="text-sm font-medium text-slate-700">Your Text</label>
            <div class="flex gap-3">
              <button
                onclick="clearText()"
                class="text-xs font-medium text-slate-500 hover:text-slate-700 transition-colors"
              >
                Clear
              </button>
              <button
                onclick="copyText('clientText')"
                class="text-xs font-medium text-blue-600 hover:text-blue-700 transition-colors"
              >
                Copy
              </button>
            </div>
          </div>
          <textarea
            id="clientText"
            oninput="sendText()"
            placeholder="Type here to sync with host..."
            class="w-full h-48 md:h-64 p-3 bg-white border border-slate-200 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 resize-none font-mono text-sm transition-all"
          ></textarea>
        </section>
      </div>

      <!-- File Upload Section -->
      <section class="space-y-3">
        <label class="text-sm font-medium text-slate-700"
          >Send File to Host</label
        >
        <div
          id="dropZone"
          class="border-2 border-dashed border-slate-300 rounded-lg p-8 text-center hover:bg-slate-50 hover:border-blue-400 transition-all cursor-pointer group"
        >
          <input
            type="file"
            id="fileInput"
            class="hidden"
            onchange="handleFileSelect(this.files)"
          />
          <div class="pointer-events-none">
            <svg
              class="w-10 h-10 mx-auto text-slate-400 group-hover:text-blue-500 transition-colors mb-3"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
              ></path>
            </svg>
            <p class="text-sm text-slate-600 font-medium">
              Click to upload or drag and drop
            </p>
            <p class="text-xs text-slate-400 mt-1">Any file type supported</p>
          </div>
        </div>
      </section>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Available Files Section -->
        <section class="space-y-3">
          <label class="text-sm font-medium text-slate-700"
            >Host Files (Download)</label
          >
          <div
            class="bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden h-64 overflow-y-auto"
          >
            <ul id="fileList" class="divide-y divide-slate-100">
              <!-- Empty State -->
              <li class="p-8 text-center text-slate-400 text-sm">
                No files available
              </li>
            </ul>
          </div>
        </section>

        <!-- Your Uploaded Files Section -->
        <section class="space-y-3">
          <label class="text-sm font-medium text-slate-700"
            >Your Uploaded Files</label
          >
          <div
            class="bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden h-64 overflow-y-auto"
          >
            <ul id="uploadedFileList" class="divide-y divide-slate-100">
              <!-- Empty State -->
              <li class="p-8 text-center text-slate-400 text-sm">
                No files uploaded
              </li>
            </ul>
          </div>
        </section>
      </div>
    </div>

    <script>
      let lastHostText = "";

      // --- Initialization ---
      function init() {
        fetch("/init")
          .then((r) => r.json())
          .then((data) => {
            document.getElementById("clientIp").textContent = data.ip;
            document.getElementById("hostText").value = data.hostText;
            document.getElementById("clientText").value = data.clientText;
            lastHostText = data.hostText;
            poll();
          })
          .catch((err) => {
            console.error(err);
            showToast("Failed to connect to host", "error");
          });
      }

      // --- Polling ---
      function poll() {
        fetch("/poll")
          .then((r) => r.json())
          .then((data) => {
            const hostTextArea = document.getElementById("hostText");
            if (data.hostText !== lastHostText) {
              hostTextArea.value = data.hostText;
              lastHostText = data.hostText;
            }
            updateFiles(data.files);
            if (data.uploadedFiles) {
              updateUploadedFiles(data.uploadedFiles);
            }
          })
          .catch(console.error)
          .finally(() => setTimeout(poll, 1000));
      }

      // --- Text Sync ---
      function sendText() {
        const text = document.getElementById("clientText").value;
        fetch("/text", { method: "POST", body: text });
      }

      function clearText() {
        document.getElementById("clientText").value = "";
        sendText();
      }

      function copyText(elementId) {
        const el = document.getElementById(elementId);
        el.select();
        document.execCommand("copy");
        window.getSelection().removeAllRanges();
        showToast("Copied to clipboard", "success");
      }

      // --- File Handling ---
      function updateFiles(files) {
        const list = document.getElementById("fileList");
        if (!files || files.length === 0) {
          list.innerHTML =
            '<li class="p-8 text-center text-slate-400 text-sm">No files available</li>';
          return;
        }

        list.innerHTML = files
          .map(
            (f) => `
                <li class="p-3 flex items-center justify-between hover:bg-slate-50 transition-colors group">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="p-2 bg-blue-50 text-blue-600 rounded-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        </div>
                        <div class="min-w-0">
                            <p class="text-sm font-medium text-slate-900 truncate">${
                              f.FileName
                            }</p>
                            <p class="text-xs text-slate-500">${formatSize(
                              f.FileSize
                            )}</p>
                        </div>
                    </div>
                    <a href="/download/${encodeURIComponent(f.FileName)}" 
                       class="px-3 py-1.5 text-xs font-medium text-blue-600 bg-blue-50 rounded-md hover:bg-blue-100 transition-colors opacity-0 group-hover:opacity-100">
                        Download
                    </a>
                </li>
            `
          )
          .join("");
      }

      function updateUploadedFiles(files) {
        const list = document.getElementById("uploadedFileList");
        if (!files || files.length === 0) {
          list.innerHTML =
            '<li class="p-8 text-center text-slate-400 text-sm">No files uploaded</li>';
          return;
        }

        list.innerHTML = files
          .map(
            (f) => `
                <li class="p-3 flex items-center justify-between hover:bg-slate-50 transition-colors group">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="p-2 bg-green-50 text-green-600 rounded-lg">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        </div>
                        <div class="min-w-0">
                            <p class="text-sm font-medium text-slate-900 truncate">${
                              f.FileName
                            }</p>
                            <p class="text-xs text-slate-500">${formatSize(
                              f.FileSize
                            )}</p>
                        </div>
                    </div>
                    <button onclick="deleteFile('${f.FileName}')" 
                       class="p-1.5 text-red-500 hover:bg-red-50 rounded-md transition-colors opacity-0 group-hover:opacity-100" title="Delete File">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </li>
            `
          )
          .join("");
      }

      function deleteFile(filename) {
        if (!confirm(`Are you sure you want to delete "${filename}"?`)) return;

        fetch(`/files?name=${encodeURIComponent(filename)}`, {
          method: "DELETE",
        })
          .then((response) => {
            if (response.ok) {
              showToast("File deleted", "success");
              // Poll will update the list
            } else {
              showToast("Failed to delete file", "error");
            }
          })
          .catch((err) => {
            console.error(err);
            showToast("Error deleting file", "error");
          });
      }

      function formatSize(bytes) {
        if (bytes === 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + " " + sizes[i];
      }

      // --- File Upload ---
      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("fileInput");

      dropZone.addEventListener("click", () => fileInput.click());
      dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("border-blue-500", "bg-blue-50");
      });
      dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("border-blue-500", "bg-blue-50");
      });
      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("border-blue-500", "bg-blue-50");
        handleFileSelect(e.dataTransfer.files);
      });

      function handleFileSelect(files) {
        if (files.length === 0) return;
        const file = files[0]; // Handle single file for now
        uploadFile(file);
      }

      function uploadFile(file) {
        showToast(`Uploading ${file.name}...`, "info");

        fetch("/upload", {
          method: "POST",
          headers: {
            "X-File-Name": encodeURIComponent(file.name),
          },
          body: file,
        })
          .then((response) => {
            if (response.ok) {
              showToast("File uploaded successfully", "success");
            } else {
              showToast("Upload failed", "error");
            }
          })
          .catch((err) => {
            console.error(err);
            showToast("Upload error", "error");
          });
      }

      // --- Toast Notifications ---
      function showToast(text, type = "info") {
        const colors = {
          info: "linear-gradient(to right, #3b82f6, #2563eb)",
          success: "linear-gradient(to right, #22c55e, #16a34a)",
          error: "linear-gradient(to right, #ef4444, #dc2626)",
        };

        Toastify({
          text: text,
          duration: 3000,
          gravity: "bottom",
          position: "right",
          style: {
            background: colors[type],
            borderRadius: "8px",
            fontSize: "14px",
            boxShadow: "0 4px 6px -1px rgba(0, 0, 0, 0.1)",
          },
        }).showToast();
      }

      // Start
      init();
    </script>
  </body>
</html>
